# 如何开发新功能

本文档为开发人员提供在本项目中新增功能或页面的标准流程指南。

## 开发流程

本实践提倡新功能开发遵循以下步骤：

1. 前端开发（表现和行为层）
2. 后端开发（API）
3. 前端联调（数据层）

基于AI辅助的开发模式和传统开发模式有所不同。传统的开发模式强调并行开发，一般先设计程序，再设计服务接口标准，然后开发人员基于该接口标准分别实现前后端程序，再联调测试。而基于AI辅助的开发实践一般提倡“原型既前端”，将功能设计和前端开发过程合并，在根据前端设计开发后端服务。

## 前端开发

### 1. 创建页面组件

在 `src/pages/` 目录下创建新的页面文件（建议使用小驼峰命名，例如 `products.tsx`）。

```tsx
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

export function ProductsPage() {
  return (
    <div className="space-y-6">
      <h1 className="text-3xl font-bold">产品管理</h1>
      <Card>
        <CardHeader>
          <CardTitle>产品列表</CardTitle>
        </CardHeader>
        <CardContent>
          {/* 功能实现代码 */}
        </CardContent>
      </Card>
    </div>
  );
}
```

### 2. 配置路由

在 `src/App.tsx` 中导入新页面，并将其添加到路由配置中。

```tsx
// ... 其他导入
import { ProductsPage } from '@/pages/products';

export function App() {
  return (
    <Routes>
      <Route element={<ProtectedRoute />}>
        <Route path="/" element={<MainLayout />}>
          {/* 在此处添加新路由 */}
          <Route path="products" element={<ProductsPage />} />
        </Route>
      </Route>
    </Routes>
  );
}
```

### 3. 添加到侧边栏菜单

编辑 `src/components/layout/Sidebar.tsx`，在 `menuItems` 常量中增加对应的配置项。

```tsx
import { PackageIcon } from '@hugeicons/core-free-icons'; // 引入图标

const menuItems: MenuItem[] = [
  // ... 其他菜单
  {
    title: '产品管理',
    path: '/products',
    icon: PackageIcon,
    // adminOnly: true, // 如果只允许超级管理员看到
  },
];
```

## 后端开发

无论通过 PocketBase 提供的 UI 界面，还是通过 MCP （强烈推荐），后端开发都基于以下流程：

1.  启动 PocketBase 控制台 (默认 `http://127.0.0.1:8090/_/`)。
2.  创建新的 **Collection** (例如 `posts`, `products` 等)。
3.  配置字段类型并设置 **API Rules** (ACL)，确保安全访问。
4.  创建 Mock 数据，以便于联调。

## 后端联调开发

本项目使用 [PocketBase SDK](https://github.com/pocketbase/js-sdk) 与后端进行交互。

`src/lib/pocketbase.ts` 已经导出了 `pb` 实例，直接使用即可。

主要开发模式如下：

### 1. 基础调用

在组件中通过 `pb` 实例访问集合：

```tsx
import { pb } from '@/lib/pocketbase';

// 获取列表
const records = await pb.collection('your_collection').getList(1, 20, {
    filter: 'status = "active"',
    sort: '-created',
});

// 创建记录
const record = await pb.collection('your_collection').create({
    title: 'Hello World',
    user: pb.authStore.model?.id,
});
```

### 2. 文件上传与展示

- **上传**：使用 `FormData` 对象。
- **展示**：使用 `pb.files.getUrl(record, filename)` 生成完整 URL（或通过 `pb.baseUrl` 自行拼接）。

```tsx
const formData = new FormData();
formData.append('avatar', fileInput.files[0]);
await pb.collection('users').update('RECORD_ID', formData);

// 获取图片 URL
const url = pb.files.getUrl(record, record.avatar);
```

### 3. 实时订阅 (可选)

如果功能需要实时更新（如聊天、通知），可以使用 `subscribe`：

```tsx
useEffect(() => {
    pb.collection('your_collection').subscribe('*', (e) => {
        console.log(e.record); // 实时接收更新
    });
    return () => { pb.collection('your_collection').unsubscribe(); };
}, []);
```

### 4. 调试建议

- 使用浏览器控制台查看 Network 请求。PocketBase 的请求通常是标准的 RESTful 调用。
- 检查 `pb.authStore.isValid` 确认登录状态。
- 如果请求返回 403，请检查 PocketBase 后端的 **API Rules** 配置是否允许当前用户的角色访问。

## 最佳实践与建议

### UI 组件使用
-   **Shadcn/UI**: 始终优先使用 `src/components/ui/` 下的组件。
-   **图标**: 统一使用 `@hugeicons/react` 和 `@hugeicons/core-free-icons`。
-   **样式**: 使用 Tailwind CSS 进行布局。项目已配置原生的蓝色主题色和 Maia 风格。

### 数据获取
-   使用 `pb.collection('xxx').getList()` 等方法进行异步获取。
-   建议在页面中使用 `useState` 和 `useEffect` 管理加载状态 (`loading`) 和错误状态。

### 权限控制
-   如果该功能具有敏感性，请在 `App.tsx` 中使用 `<AdminOnlyRoute>` 包裹路由。
-   在 `menuItems` 配置中设置 `adminOnly: true` 以隐藏入口。

### 工具函数
-   `src/lib/utils.ts` 包含常用的 `cn` 函数，用于合并 Tailwind 类名。
